### 0X01 å‰è¨€

ä»Šå¤©æˆ‘ä»¬èŠä¸€èŠ flask çš„é…ç½®

### 0X02 æºç 

è¿™æ¬¡çš„ flask ä¸“é—¨åˆ›å»ºä¸€ä¸ªç±» Config ç”¨äºé…ç½®è¯»å–å’Œè®¾ç½®

```python
class Config(dict):

    def __init__(self, root_path, defaults=None):
        dict.__init__(self, defaults or {})
        self.root_path = root_path

    def from_envvar(self, variable_name, silent=False):
        rv = os.environ.get(variable_name)
        if not rv:
            if silent:
                return False
            raise RuntimeError('The environment variable %r is not set '
                               'and as such configuration could not be '
                               'loaded.  Set this variable and make it '
                               'point to a configuration file' %
                               variable_name)
        self.from_pyfile(rv)
        return True

    def from_pyfile(self, filename):
        filename = os.path.join(self.root_path, filename)
        d = type(sys)('config')
        d.__file__ = filename
        execfile(filename, d.__dict__)
        self.from_object(d)

    def from_object(self, obj):
        if isinstance(obj, basestring):
            obj = import_string(obj)
        for key in dir(obj):
            if key.isupper():
                self[key] = getattr(obj, key)

    def __repr__(self):
        return '<%s %s>' % (self.__class__.__name__, dict.__repr__(self))
```

è¿™é‡Œæä¾›äº†ä¸‰ç§å¯¼å…¥é…ç½®çš„æ–¹æ³•ï¼Œå½’æ ¹ç»“åº•éƒ½æ˜¯ä½¿ç”¨ from_object() å¯¼å…¥é…ç½®

å€¼å¾—æ³¨æ„çš„æ˜¯è¿™ä¸ª execfile() å‡½æ•°ï¼Œè¿™æ˜¯ Python2 è‡ªå¸¦å‡½æ•°ï¼Œç­‰ä»·äº Python3 ä¸­è°ƒç”¨ open() compile() å’Œ exec() 

`execfile(filename[, globals[, locals]])` è¿™æ˜¯å®ƒçš„è°ƒç”¨æ–¹å¼

- filename -- æ–‡ä»¶åã€‚
- globals -- å˜é‡ä½œç”¨åŸŸï¼Œå…¨å±€å‘½åç©ºé—´ï¼Œå¦‚æœè¢«æä¾›ï¼Œåˆ™å¿…é¡»æ˜¯ä¸€ä¸ªå­—å…¸å¯¹è±¡ã€‚
- locals -- å˜é‡ä½œç”¨åŸŸï¼Œå±€éƒ¨å‘½åç©ºé—´ï¼Œå¦‚æœè¢«æä¾›ï¼Œå¯ä»¥æ˜¯ä»»ä½•æ˜ å°„å¯¹è±¡ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å®é™…æ“ä½œä¸€ä¸‹ï¼ˆæˆ‘ç”¨çš„æ˜¯ Python3.6ï¼‰

```python
# exce æ–‡ä»¶
a=1
b=2
def f():
    c = 4

# test1.py æ–‡ä»¶
d = ï½›ï½
print('before', d)
with open('exce', 'r') as f:
    exec(f.read(), d)
print('after', d)

# ç»“æœ
# çœç•¥å·çš„å†…å®¹æ˜¯è¢«å¯¼å…¥å…¨å±€å‘½åç©ºé—´çš„ Python å†…ç½®å‡½æ•°
before {}
after {'__builtins__': {...}, 'a': 1, 'b': 2, 'f': <function f at 0x000002B6703F0BF8>}


# test2.py æ–‡ä»¶
d = {}
local = {}
print('before', d, local)
with open('exce', 'r') as f:
    exec(f.read(), d, local)
print('after', d)
print('local', local)

# ç»“æœ
before {} {}
after {'__builtins__': {...}
local {'a': 1, 'b': 2, 'f': <function f at 0x000001F0B1C52E18>}
```

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹è¿™ä¸ª import_string()

```python
# werkzeug0.6.1 ä½¿ç”¨çš„æ˜¯ Python2
def import_string(import_name, silent=False):
    # force the import name to automatically convert to strings
    if isinstance(import_name, unicode):
        import_name = str(import_name)
    try:
        if ':' in import_name:
            module, obj = import_name.split(':', 1)
        elif '.' in import_name:
            module, obj = import_name.rsplit('.', 1)
        else:
            return __import__(import_name)
        # __import__ is not able to handle unicode strings in the fromlist
        # if the module is a package
        if isinstance(obj, unicode):
            obj = obj.encode('utf-8')
        return getattr(__import__(module, None, None, [obj]), obj)
    except (ImportError, AttributeError):
        if not silent:
            raise
```

è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œä»£ç å³æ˜¯è§£é‡Š

æ¥ç€çœ‹è¿™ä¸ªé…ç½®ç±»çš„ä½¿ç”¨

```python
class ConfigAttribute(object):
    """Makes an attribute forward to the config"""

    def __init__(self, name):
        self.__name__ = name

    def __get__(self, obj, type=None):
        if obj is None:
            return self
        return obj.config[self.__name__]

    def __set__(self, obj, value):
        obj.config[self.__name__] = value


class Flask(_PackageBoundObject):
    ...
    debug = ConfigAttribute('DEBUG')
    testing = ConfigAttribute('TESTING')
    secret_key = ConfigAttribute('SECRET_KEY')
    session_cookie_name = ConfigAttribute('SESSION_COOKIE_NAME')
    permanent_session_lifetime = ConfigAttribute('PERMANENT_SESSION_LIFETIME')
    use_x_sendfile = ConfigAttribute('USE_X_SENDFILE')
    logger_name = ConfigAttribute('LOGGER_NAME')
    default_config = ImmutableDict({
        'DEBUG':                                False,
        'TESTING':                              False,
        'SECRET_KEY':                           None,
        'SESSION_COOKIE_NAME':                  'session',
        'PERMANENT_SESSION_LIFETIME':           timedelta(days=31),
        'USE_X_SENDFILE':                       False,
        'LOGGER_NAME':                          None
    })
    ...
    
    def __init__(self, import_name):
        _PackageBoundObject.__init__(self, import_name)

        #: The configuration dictionary as :class:`Config`.  This behaves
        #: exactly like a regular dictionary but supports additional methods
        #: to load a config from files.
        self.config = Config(self.root_path, self.default_config)
        ...
```

ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªé…ç½®çš„ä½¿ç”¨éœ€è¦æ­é… ConfigAttribute ç±»

åƒ ConfigAttribute è¿™æ ·çš„ç±»æœ‰ä¸ªä¸“æœ‰åç§°â€”â€”æè¿°ç¬¦ï¼Œå®ƒä½¿å¾—å®ä¾‹å¯ä»¥å¯¹ç±»å±æ€§è¿›è¡Œ get å’Œ set æ“ä½œ

ä¸¾ä¸ªä¾‹å­ğŸŒ°

```python
class ConfigAttribute(object):

    def __init__(self, name):
        self.__name__ = name

    def __get__(self, obj, owner):
        print('è°ƒç”¨ __get__')
        print('self: {}, obj: {}, owner: {}'.format(type(self), type(obj), type(owner)))
        if obj is None:
            return self
        return obj.config[self.__name__]

    def __set__(self, obj, value):
        print('è°ƒç”¨ __set__')
        print('self: {}, obj: {}, value: {}'.format(type(self), type(obj), value))
        obj.config[self.__name__] = value


class Flask(object):
    debug = ConfigAttribute('DEBUG')

    def __init__(self):
        self.config = {'DEBUG': False}


app = Flask()
print(app.debug)
app.debug = True

# ç»“æœ
è°ƒç”¨ __get__
<self: <class '__main__.ConfigAttribute'>, obj: <class '__main__.Flask'>, owner: <class 'type'>>
False
è°ƒç”¨ __set__
<self: <class '__main__.ConfigAttribute'>, obj: <class '__main__.Flask'>, value: True>
```

å¤§ä½“æƒ…å†µå°±æ˜¯ä¸Šé¢æ‰€ç¤ºï¼ˆæ¬²çŸ¥æ›´å¤šï¼Œè¯·ç™¾åº¦æˆ–è°·æ­Œï¼‰

è¦äº†è§£ Python çš„é­”æ³•æ–¹æ³•çš„è¯å¯ä»¥å‚è€ƒè¿™ç¯‡ [Pythoné­”æ³•æ–¹æ³•æŒ‡å—](https://pyzh.readthedocs.io/en/latest/python-magic-methods-guide.html)

### 0X03 åè®°

