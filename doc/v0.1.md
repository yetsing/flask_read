### 0X01 å‰è¨€

flask çš„å£å· `because a pocket knife is not the only thing that might come in handy`

æˆ–è€… `because sometimes a pocket knife is not enough` è¿™å¥

æ„æ€åº”è¯¥æ˜¯è¯´ flask ç®€å•æ˜“ä¸Šæ‰‹ï¼ˆæ·±è¡¨èµåŒğŸ˜‚ï¼‰

ä»æ–‡ä»¶ç»“æ„çœ‹ï¼Œ0.1 ç‰ˆæœ¬çš„ flask ä»£ç åªæœ‰ä¸€ä¸ª flask.py æ–‡ä»¶ï¼Œå¯ä»¥è¯´æ˜¯éå¸¸åœ°å°å·§è½»ä¾¿äº†

### 0X02 æºç 

æ—¢ç„¶æ˜¯çœ‹æºç ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦å…ˆé€‰æ‹©ä¸€ä¸ªç‚¹åˆ‡å…¥ï¼Œè¿™æ ·é€»è¾‘æ›´ä¸ºé¡ºç•…æ¸…æ™°

#### hello world

è®©æˆ‘ä»¬å…ˆä»è¿™ä¸ª hello world è¯´èµ·

```python
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello_world():
    return 'Hello, World!'

if __name__ == '__main__':
    app.run()
```

é¦–å…ˆæ˜¯å¯¼å…¥ Flask ç±»ï¼Œåˆå§‹åŒ–ç±»å±æ€§

```python
class Flask(object):
    
    request_class = Request

    response_class = Response

    # é™æ€æ–‡ä»¶çš„è·¯å¾„
    static_path = '/static'

    # å¯†é’¥ï¼Œç”¨äºç»™ cookie å’Œå…¶ä»–ä¸œè¥¿ç­¾åï¼Œé˜²æ­¢å‡å†’å’Œç¯¡æ”¹
    secret_key = None

    # cookie å‡ºç°çš„ session=... ä¸­çš„ session
    session_cookie_name = 'session'

    # jinja2 ç¯å¢ƒçš„å‚æ•°
    jinja_options = dict(
        autoescape=True, # è‡ªåŠ¨è½¬ä¹‰
        # jinja2 çš„ä¸¤ä¸ªæ‰©å±•ï¼Œ autoescape æ˜¯è‡ªåŠ¨è½¬ä¹‰ï¼Œ with_ æ˜¯æ”¯æŒ with å…³é”®å­—
        extensions=['jinja2.ext.autoescape', 'jinja2.ext.with_']
    )
```



æ¥ç€è·å– Flask ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œè°ƒç”¨äº† Flask.\_\_init\_\_ æ–¹æ³•

```python
    def __init__(self, package_name):
        # debug æ¨¡å¼
        self.debug = False
        self.package_name = package_name
        self.root_path = _get_package_path(self.package_name)
        self.view_functions = {}
        self.error_handlers = {}
        self.before_request_funcs = []
        self.after_request_funcs = []
        # åˆ›å»ºæ¨¡æ¿ä¸Šä¸‹æ–‡æ—¶ï¼Œä¼šè°ƒç”¨è¿™é‡Œçš„å‡½æ•°æ›´æ–°æ¨¡æ¿ä¸Šä¸‹æ–‡çš„å˜é‡å­—å…¸
        # _default_template_ctx_processor ç”¨æ¥æ³¨å†Œ request session g
        self.template_context_processors = [_default_template_ctx_processor]

        self.url_map = Map()

        if self.static_path is not None:
            self.url_map.add(Rule(self.static_path + '/<filename>',
                                  build_only=True, endpoint='static'))
            if pkg_resources is not None:
                target = (self.package_name, 'static')
            else:
                target = os.path.join(self.root_path, 'static')
            # SharedDataMiddleware æ˜¯ werkzeug æä¾›çš„ç”¨äºå¤„ç†é™æ€æ–‡ä»¶çš„ä¸­é—´ä»¶
            self.wsgi_app = SharedDataMiddleware(self.wsgi_app, {
                self.static_path: target
            })

        self.jinja_env = Environment(loader=self.create_jinja_loader(),
                                     **self.jinja_options)
        self.jinja_env.globals.update(
            url_for=url_for,
            get_flashed_messages=get_flashed_messages
        )
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ä¾‹åŒ–è¿‡ç¨‹ä¸»è¦æ˜¯åˆå§‹åŒ–ä¸€äº›å±æ€§å’Œ jinja2 çš„ç¯å¢ƒ

ç„¶åï¼Œæˆ‘ä»¬è°ƒç”¨ Flask.route è£…é¥°å™¨æ³¨å†Œ URL å’Œå¯¹åº”çš„è§†å›¾å‡½æ•°

```python
    def route(self, rule, **options):
        def decorator(f):
            self.add_url_rule(rule, f.__name__, **options)
            self.view_functions[f.__name__] = f
            return f
        return decorator
    
    def add_url_rule(self, rule, endpoint, **options):
        options['endpoint'] = endpoint
        options.setdefault('methods', ('GET',))
        self.url_map.add(Rule(rule, **options))
```

é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯å°† URL å’Œè§†å›¾å‡½æ•°åˆ†åˆ«æ·»åŠ åˆ°å®ä¾‹çš„ view_function å’Œ url_map ä¸­

æœ€åå°±æ˜¯è°ƒç”¨ Flask.run è¿è¡Œç¨‹åº

```python
    def run(self, host='localhost', port=5000, **options):
        from werkzeug import run_simple
        if 'debug' in options:
            self.debug = options.pop('debug')
        options.setdefault('use_reloader', self.debug)
        options.setdefault('use_debugger', self.debug)
        return run_simple(host, port, self, **options)
```

å¯¹ debug æ¨¡å¼è®¾ç½®ä¸€ä¸‹åï¼Œç›´æ¥å°†æ‰€æœ‰å‚æ•°ä¼ ç»™äº† werkzeug çš„ run_simple

ä¸‹é¢æ˜¯ werkzeug0.6.1 çš„ run_simple å‡½æ•°ä»£ç 

```python
def run_simple(hostname, port, application, use_reloader=False,
               use_debugger=False, use_evalex=True,
               extra_files=None, reloader_interval=1, threaded=False,
               processes=1, request_handler=None, static_files=None,
               passthrough_errors=False, ssl_context=None):
    if use_debugger:
        from werkzeug.debug import DebuggedApplication
        application = DebuggedApplication(application, use_evalex)
    if static_files:
        from werkzeug.wsgi import SharedDataMiddleware
        application = SharedDataMiddleware(application, static_files)

    def inner():
        make_server(hostname, port, application, threaded,
                    processes, request_handler,
                    passthrough_errors, ssl_context).serve_forever()

    if os.environ.get('WERKZEUG_RUN_MAIN') != 'true':
        display_hostname = hostname != '*' and hostname or 'localhost'
        if ':' in display_hostname:
            display_hostname = '[%s]' % display_hostname
        _log('info', ' * Running on %s://%s:%d/', ssl_context is None
             and 'http' or 'https', display_hostname, port)
    if use_reloader:
        # Create and destroy a socket so that any exceptions are raised before
        # we spawn a separate Python interpreter and lose this ability.
        test_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        test_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        test_socket.bind((hostname, port))
        test_socket.close()
        run_with_reloader(inner, extra_files, reloader_interval)
    else:
        inner()
```

run_simple æ ¹æ®å‚æ•°è®¾ç½®è°ƒè¯•å™¨ï¼ˆdebuggerï¼‰é‡è½½å™¨ï¼ˆreloaderï¼‰ä»¥åŠé™æ€æ–‡ä»¶å¤„ç†ä¸­é—´ä»¶

æœ€åè°ƒç”¨ make_server(...).serve_forever() å¼€å¯æœåŠ¡å™¨ï¼Œæˆ‘ä»¬çš„ app å®ä¾‹ä¹Ÿè¢«ä¼ è¿›è¿™ä¸ªæœåŠ¡å™¨



#### è¯·æ±‚â€”â€”å“åº”

æ ¹æ® wsgi åè®®

å½“æ”¶åˆ°è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè°ƒç”¨æˆ‘ä»¬ä¹‹å‰ä¼ å…¥çš„ app å®ä¾‹ `app(environ, start_response)`

å³ `app.__call__(environ, start_response)`

```python
    def __call__(self, environ, start_response):
        return self.wsgi_app(environ, start_response)
    
    def wsgi_app(self, environ, start_response):
        with self.request_context(environ):
            # é¢„å¤„ç†ï¼Œè°ƒç”¨ self.before_request_funcs ä¸­çš„å‡½æ•°
            rv = self.preprocess_request()
            if rv is None:
                # è°ƒç”¨æ³¨å†Œçš„è§†å›¾å‡½æ•°
                rv = self.dispatch_request()
            response = self.make_response(rv)
            # è°ƒç”¨ self.after_request_funcs ä¸­çš„å‡½æ•°
            response = self.process_response(response)
            return response(environ, start_response)
```

åœ¨è¿™é‡Œï¼Œä¹‹æ‰€ä»¥ä¸å°† wsgi_app å‡½æ•°ä»£ç ç›´æ¥å†™åˆ° \_\_call\_\_ å‡½æ•°ä¸­ï¼Œæ˜¯ä¸ºäº†åœ¨ç»™ app å®ä¾‹æ·»åŠ ä¸­é—´ä»¶æ—¶ï¼Œä»ç„¶å¯ä»¥å¾—åˆ°æˆ‘ä»¬çš„ app å®ä¾‹

```python
# å¯ä»¥è¿™æ ·ä½¿ç”¨ä¸­é—´ä»¶ï¼Œapp ä¾ç„¶æ˜¯ Flask çš„å®ä¾‹
app.wsgi_app = ä¸­é—´ä»¶(app.wsgi_app)
# ä¸ç”¨è¿™æ ·ä½¿ç”¨
app = ä¸­é—´ä»¶(app)
```

å¼€å¤´çš„ `with self.request_context(environ) ` è°ƒç”¨ï¼Œæˆ‘ä»¬å¾—åˆ°å½“å‰çš„è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œå¹¶å°†å…¶ push åˆ°æœ¬åœ°è¯·æ±‚ä¸Šä¸‹æ–‡å †æ ˆ(_request_ctx_stack)

```python
class Flask(obeject):
    
    def request_context(self, environ):
        return _RequestContext(self, environ)

    
class _RequestContext(object):

    def __init__(self, app, environ):
        self.app = app
        self.url_adapter = app.url_map.bind_to_environ(environ)
        self.request = app.request_class(environ)
        self.session = app.open_session(self.request)
        self.g = _RequestGlobals()
        self.flashes = None

    def __enter__(self):
        _request_ctx_stack.push(self)

    def __exit__(self, exc_type, exc_value, tb):
        # do not pop the request stack if we are in debug mode and an
        # exception happened.  This will allow the debugger to still
        # access the request object in the interactive shell.
        if tb is None or not self.app.debug:
            _request_ctx_stack.pop()
```

ä¹‹åçš„ä»£ç å°±æ˜¯è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹

æˆ‘ä»¬ä¸»è¦çœ‹ `self.dispatch_request()` 

```python
    def dispatch_request(self):
        try:
            endpoint, values = self.match_request()
            return self.view_functions[endpoint](**values)
        except HTTPException, e:
            handler = self.error_handlers.get(e.code)
            if handler is None:
                return e
            return handler(e)
        except Exception, e:
            handler = self.error_handlers.get(500)
            if self.debug or handler is None:
                raise
            return handler(e)
```

å…ˆæ˜¯å¯¹ URL è¿›è¡ŒåŒ¹é…ï¼Œå¾—åˆ°å¯¹åº”çš„ç«¯ç‚¹å’Œå˜é‡å€¼ï¼ˆå¦‚ /<name> ä¸­çš„ name å˜é‡ï¼‰

å†æ ¹æ®ç«¯ç‚¹å¾—åˆ°å¯¹åº”çš„è§†å›¾å‡½æ•°ï¼Œå°†å˜é‡å€¼ä¼ å…¥

å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œè°ƒç”¨æˆ‘ä»¬æ³¨å†Œçš„é”™è¯¯å¤„ç†å™¨(error_handler)æˆ–è€…æŠ›å‡º



### 0X03 åè®°

ç¬¬ä¸€æ¬¡è‡ªå·±çœ‹æºç ï¼Œå‡ºå¸ˆä¸åˆ©ã€‚

åˆšå¼€å§‹æ€»æƒ³ç€æŠŠæ‰€æœ‰éƒ½ææ‡‚ï¼Œè„‘ä¸­å¯ä»¥è¯´æ˜¯ä¸€å›¢ä¹±éº»ã€‚

åé¢å­¦ä¹–äº†ï¼ŒæŠŠ werkzeug çš„ä¸œè¥¿éƒ½çœ‹åšé»‘ç®±ï¼Œä¸å»è¿½ç©¶å®ƒçš„å®ç°ï¼Œé¡¿æ—¶æ€è·¯å°±æ¸…æ™°äº†ã€‚

æœ€åï¼Œæˆ‘æƒ³åŸä¸¤å¥è¯—

**æŠ˜æˆŸæ²‰æ²™é“æœªé”€ï¼Œè‡ªå°†ç£¨æ´—è®¤å‰æœ**

- ç•ªå¤–ï¼š[è¯·æ±‚ä¸Šä¸‹æ–‡çš„åˆ†æ](https://github.com/yetsing/flask_read/blob/master/doc/v0.1__request_ctx_stack.md)