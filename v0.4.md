### 0X01 å‰è¨€

ä»Šå¤©ç›´æ¥è·³è·ƒåˆ° 0.4 ç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬çš„ä»£ç å¯ä»¥è¯´æ˜¯å¾ˆå¤æ‚äº†

è®©æˆ‘ä»¬ä¸å¿˜åˆå¿ƒï¼Œç»§ç»­å‰è¡Œ

### 0X02 æºç 

- hello world

è¿™æ¬¡çš„ Flask ç»§æ‰¿äº† _PackageBoundObject ç±»

```python
class _PackageBoundObject(object):

    def __init__(self, import_name):
        #: The name of the package or module.  Do not change this once
        #: it was set by the constructor.
        self.import_name = import_name

        #: Where is the app root located?
        self.root_path = _get_package_path(self.import_name)

    def open_resource(self, resource):
        if pkg_resources is None:
            return open(os.path.join(self.root_path, resource), 'rb')
        return pkg_resources.resource_stream(self.import_name, resource)
```

_PackageBoundObject ç±»ä¸»è¦ç”¨äºå®šä½ app çš„è·¯å¾„ä»¥åŠæ‰“å¼€æ–‡ä»¶

åœ¨ç±»å±æ€§å’Œ \_\_init\_\_ () æ–¹æ³•ä¸Šé¢ï¼Œä¸»è¦æ˜¯å¢åŠ äº†ä¸€äº›æ–°çš„é…ç½®([é…ç½®ç®¡ç† Config]()è§£æ)ã€æ—¥å¿—ã€‚

- è¯·æ±‚â€”â€”å“åº”

åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šä»£ç 

```python
    def __call__(self, environ, start_response):
        """Shortcut for :attr:`wsgi_app`."""
        return self.wsgi_app(environ, start_response)
    
    def wsgi_app(self, environ, start_response):
        with self.request_context(environ):
            try:
                rv = self.preprocess_request()
                if rv is None:
                    rv = self.dispatch_request()
                response = self.make_response(rv)
            except Exception, e:
                response = self.make_response(self.handle_exception(e))
            try:
                response = self.process_response(response)
            except Exception, e:
                response = self.make_response(self.handle_exception(e))
            return response(environ, start_response)
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸»è¦çš„å˜åŒ–å°±æ˜¯å¢åŠ äº†å¼‚å¸¸å¤„ç†ä»¥åŠå°†å¼‚å¸¸å¤„ç†çš„è¿‡ç¨‹ä¸“é—¨å°è£…æˆäº†ä¸€ä¸ªå‡½æ•°ï¼Œæ²¡æœ‰åƒä¹‹å‰ä¸€æ ·å†™åœ¨ä¸€èµ·ï¼ˆè¿™æ˜¯å¥½æ ·çš„ :-ï¼‰

- P.S.

è¿™é‡Œè¦è¡¥å……è¯´ä¸€ä¸‹ Request ç±»çš„ä¸€ä¸ªæœ‰æ„æ€çš„è£…é¥°å™¨ï¼Œå¦‚ä¸‹

```python
class Request(RequestBase):
    ...

    @cached_property
    def json(self):
        """If the mimetype is `application/json` this will contain the
        parsed JSON data.
        """
        if __debug__:
            _assert_have_json()
        if self.mimetype == 'application/json':
            return json.loads(self.data)
```

å°±æ˜¯è¿™ä¸ª `@cached_property` ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯ç¼“å­˜ json è¿™ä¸ªå±æ€§çš„å€¼ï¼Œé¿å…é‡å¤æ‰§è¡Œ `json()` è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬ç»™ä¸Šé¢çš„ä»£ç æ¢ä¸€ç§å†™æ³•ï¼Œè¿™æ ·æ›´å®¹æ˜“å¼„æ‡‚åŸç†

```python
class Request(RequestBase):
    ...

    def json(self):
        """If the mimetype is `application/json` this will contain the
        parsed JSON data.
        """
        if __debug__:
            _assert_have_json()
        if self.mimetype == 'application/json':
            return json.loads(self.data)
    
    json = cached_property(json)
```

ä¸‹é¢æ˜¯ `cached_property`  çš„ä»£ç 

```python
# Werkzeug 0.6.1
class cached_property(object):

    def __init__(self, func, name=None, doc=None, writeable=False):
        if writeable:
            from warnings import warn
            warn(DeprecationWarning('the writeable argument to the '
                                    'cached property is a noop since 0.6 '
                                    'because the property is writeable '
                                    'by default for performance reasons'))

        self.__name__ = name or func.__name__
        self.__module__ = func.__module__
        self.__doc__ = doc or func.__doc__
        self.func = func

    def __get__(self, obj, type=None):
        if obj is None:
            return self
        value = obj.__dict__.get(self.__name__, _missing)
        if value is _missing:
            value = self.func(obj)
            obj.__dict__[self.__name__] = value
        return value
```

æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„è£…é¥°å™¨æ˜¯ä¸ªå‡½æ•°ï¼Œè€Œè¿™é‡Œåˆ™æ˜¯ä¸ªç±»

ä¸Šé¢çš„ `__get__` æ–¹æ³•ä¼šåœ¨æˆ‘ä»¬è°ƒç”¨ Request çš„ json å±æ€§æ—¶è°ƒç”¨ï¼Œå…¶ä¸­çš„å‚æ•° obj æ˜¯ Request ç±»çš„å®ä¾‹ï¼Œtype æ˜¯ Request ç±»

å…¶å®å°±æ˜¯æˆ‘ä»¬åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œå°†ç»“æœå­˜åœ¨äº† Request ç±»å®ä¾‹çš„ `__dict__` å­—å…¸ä¸­ï¼›ä¸‹æ¬¡å†è°ƒç”¨ï¼Œç›´æ¥ä» `__dict__` ä¸­è·å–ç»“æœ

å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ `json()` æ–¹æ³•ä¸­å®ç°åŒæ ·çš„é€»è¾‘ï¼Œä»–è¿™é‡Œæ˜¯å°†è¿™ç§æ–¹æ³•æŠ½è±¡æˆäº†é€šç”¨çš„å·¥å…·

### 0X03 åè®°

è¿™æ¬¡çš„æ›´æ–°åœ¨æ ¸å¿ƒåŠŸèƒ½ä¸Šå¹¶æ²¡æœ‰åšå¤ªå¤§çš„æ”¹å˜ï¼Œä¸»è¦æ˜¯å¢åŠ äº†ä¸€äº›æ–°ç‰¹æ€§ï¼Œä¼ é€é—¨åœ¨æ­¤

[Config]()

[Module]()

ä»Šå¤©å‡ºå»é¢è¯•ï¼Œç›´æ¥åœ¨ç¬”è¯•å®Œè´¥ï¼Œå¹³æ—¶ç”¨ä¸ä¸Šçš„åŸºç¡€çŸ¥è¯†å¿«å¿˜å®Œäº†ï¼Œ

å°¤å…¶æ˜¯æ‰‹å†™ç¼–ç¨‹ï¼Œæ„Ÿè§‰è‡ªå·±å®Œå…¨ä¸ä¼šï¼ŒçœŸçœŸæ˜¯é¢å‘ç™¾åº¦ç¼–ç¨‹ğŸ¤£ï¼Œä¸æ•²é”®ç›˜æ²¡æ„Ÿè§‰

